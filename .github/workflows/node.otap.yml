name: Node.js CI

on:
  push:
    branches:
      - dev
      - test
      - prod
  pull_request:
    branches:
      - dev
      - test
      - prod

jobs:
  dev-to-test:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'npm'
      
      - name: Configure Git with token
        run: |
          git config --global user.email "MortallicaXxX@hotmail.com"
          git config --global user.name "MortallicaXxX"
          git config --global credential.helper store
          echo "https://github.com:${{ secrets.PUBLISH_TOKEN }}" > ~/.git-credentials
          chmod 0600 ~/.git-credentials
      
      - name: Fetch branch information from remote
        run: git fetch
      
      - name: Show Git status before push
        run: git status

      - name: Merge and push to test branch
        run: |
          git checkout test || git checkout -b test origin/test
          git merge --no-ff --allow-unrelated-histories -X ours dev
          git push origin test

      - name: Show Git log after push
        run: git log -1 --oneline

  test-to-prod:
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'npm'

      # Steps for building and publishing to prod branch

  prod-publish:
    if: github.ref == 'refs/heads/prod'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: 'npm'

      # Steps for publishing package
